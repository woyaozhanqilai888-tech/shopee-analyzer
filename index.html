<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopee GMV Max 广告智能诊断专家</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: Inter, system-ui; background:#f8fafc }
    .glass-card { background:rgba(255,255,255,.95); backdrop-filter:blur(12px); border:1px solid #e2e8f0 }
    .status-dot { width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px }
    .dot-idle{background:#94a3b8}
    .dot-loading{background:#f59e0b;animation:pulse 1s infinite}
    .dot-success{background:#10b981}
    .dot-error{background:#ef4444}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
  </style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const DEFAULT_PROXY = 'https://cors-anywhere.herokuapp.com/';

const PLATFORM_CONFIG = {
  openai: { name: 'ChatGPT', model: 'gpt-4o' },
  deepseek: { name: 'DeepSeek', model: 'deepseek-chat' },
  gemini: { name: 'Gemini', model: 'gemini-2.5-flash' }
};

function App() {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [apiKeys, setApiKeys] = useState({ openai:'', deepseek:'', gemini:'' });
  const [apiStatus, setApiStatus] = useState({ openai:'idle', deepseek:'idle', gemini:'idle' });
  const [results, setResults] = useState({});
  const [proxyUrl] = useState(DEFAULT_PROXY);

  /* ---------------- CSV ---------------- */
  const handleFileUpload = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      const lines = ev.target.result.split(/\r?\n/).filter(Boolean);
      const h = lines.findIndex(l => l.includes('Expense'));
      const headers = lines[h].split(',');
      let t={spend:0,gmv:0,clicks:0,imps:0,orders:0};

      lines.slice(h+1).forEach(l=>{
        const v=l.split(',');
        const p=n=>{
          const i=headers.indexOf(n);
          return i>-1?parseFloat(v[i]?.replace(/[^0-9.]/g,''))||0:0;
        };
        t.spend+=p('Expense');
        t.gmv+=p('GMV');
        t.clicks+=p('Clicks');
        t.imps+=p('Impression');
        t.orders+=p('Conversions');
      });
      setData(t);
    };
    reader.readAsText(file);
  };

  /* ---------------- API ---------------- */
  const callAIApi = async (platform, key, prompt) => {
    const p = proxyUrl.endsWith('/')?proxyUrl:proxyUrl+'/';
    let url='', body={}, headers={'Content-Type':'application/json'};

    if (platform === 'openai' || platform === 'deepseek') {
      url = platform==='openai'
        ? 'https://api.openai.com/v1/chat/completions'
        : 'https://api.deepseek.com/v1/chat/completions';

      headers.Authorization = `Bearer ${key}`;
      body = {
        model: PLATFORM_CONFIG[platform].model,
        messages: [
          { role:'system', content:'你是电商广告专家，只返回 JSON' },
          { role:'user', content:prompt }
        ],
        response_format:{ type:'json_object' }
      };

    } else {
      /* ✅ Gemini 修复版 */
      url = `https://generativelanguage.googleapis.com/v1/models/${PLATFORM_CONFIG.gemini.model}:generateContent?key=${key}`;
      body = {
        contents:[{
          role:'user',
          parts:[{
            text:
`请严格只返回 JSON，不要任何多余文字。
格式如下：
{
  "suggestions":[
    {"title":"标题","content":"内容"}
  ]
}

${prompt}`
          }]
        }],
        generationConfig:{
          temperature:0.2,
          maxOutputTokens:1024
        }
      };
    }

    const res = await fetch(p+url,{method:'POST',headers,body:JSON.stringify(body)});
    if(!res.ok) throw new Error(await res.text());
    const json = await res.json();

    let text='';
    if(platform==='gemini') text=json.candidates[0].content.parts[0].text;
    else text=json.choices[0].message.content;

    const match=text.match(/\{[\s\S]*\}/);
    return JSON.parse(match?match[0]:text);
  };

  /* ---------------- RUN ---------------- */
  const run = async () => {
    setLoading(true);
    setResults({});
    const roas=(data.gmv/data.spend).toFixed(2);
    const ctr=(data.clicks/data.imps*100).toFixed(2);
    const cvr=(data.orders/data.clicks*100).toFixed(2);

    const prompt=`广告花费 ${data.spend.toFixed(2)}，
GMV ${data.gmv.toFixed(2)}，
ROAS ${roas}，
CTR ${ctr}%，
转化率 ${cvr}%。
请给 3 条优化建议。`;

    await Promise.all(
      Object.entries(apiKeys).map(async([p,k])=>{
        if(!k) return;
        try{
          const r=await callAIApi(p,k,prompt);
          setResults(s=>({...s,[p]:{ok:true,data:r}}));
        }catch(e){
          setResults(s=>({...s,[p]:{ok:false,msg:e.message}}));
        }
      })
    );
    setLoading(false);
  };

  /* ---------------- UI ---------------- */
  return (
    <div className="max-w-6xl mx-auto p-10 space-y-8">
      <h1 className="text-3xl font-black">Shopee 广告 AI 联诊</h1>

      <input type="file" accept=".csv" onChange={handleFileUpload} />

      {data && (
        <button onClick={run} disabled={loading}
          className="bg-black text-white px-8 py-4 rounded-xl">
          {loading?'分析中...':'启动多 AI 联诊'}
        </button>
      )}

      <div className="grid md:grid-cols-3 gap-6">
        {Object.keys(results).map(p=>(
          <div key={p} className="glass-card p-6 rounded-xl">
            <h3 className="font-bold mb-4">{PLATFORM_CONFIG[p].name}</h3>
            {results[p].ok
              ? results[p].data.suggestions.map((s,i)=>(
                <div key={i} className="mb-3">
                  <b>{s.title}</b>
                  <p className="text-sm text-slate-500">{s.content}</p>
                </div>
              ))
              : <p className="text-red-500 text-xs">{results[p].msg}</p>
            }
          </div>
        ))}
      </div>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
