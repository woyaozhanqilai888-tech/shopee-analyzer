<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopee GMV Max å¹¿å‘Šæ™ºèƒ½è¯Šæ–­ä¸“å®¶ - å®Œæ•´é‡æ„ç‰ˆ</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 2px solid #fff; }
        .dot-idle { background-color: #94a3b8; }
        .dot-loading { background-color: #f59e0b; animation: pulse 1s infinite; }
        .dot-success { background-color: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .dot-error { background-color: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .ai-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .ai-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const DEFAULT_PROXY = 'https://cors-anywhere.herokuapp.com/';
        const PLATFORM_CONFIG = {
            openai: { name: 'ChatGPT', color: 'bg-emerald-500', border: 'border-emerald-200', text: 'text-emerald-700', model: 'gpt-4o' },
            deepseek: { name: 'DeepSeek', color: 'bg-blue-600', border: 'border-blue-200', text: 'text-blue-700', model: 'deepseek-chat' },
            gemini: { name: 'Gemini', color: 'bg-orange-500', border: 'border-orange-200', text: 'text-orange-700', model: 'gemini-2.5-flash' }
        };
        const App = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [apiKeys, setApiKeys] = useState({ openai: '', deepseek: '', gemini: '' });
            const [apiStatus, setApiStatus] = useState({ openai: 'idle', deepseek: 'idle', gemini: 'idle' });
            const [results, setResults] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [proxyUrl, setProxyUrl] = useState(DEFAULT_PROXY);
            const [isProxyActive, setIsProxyActive] = useState(false);
            // åˆå§‹åŒ–åŠ è½½
            useEffect(() => {
                const saved = localStorage.getItem('shopee_pro_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    setApiKeys(config.keys);
                    setProxyUrl(config.proxy || DEFAULT_PROXY);
                    checkProxyStatus(config.proxy || DEFAULT_PROXY);
                    // è‡ªåŠ¨éªŒè¯æ‰€æœ‰æœ‰Keyçš„å¹³å°
                    Object.entries(config.keys).forEach(([p, k]) => {
                        if (k) validateSingleKey(p, k, config.proxy);
                    });
                }
            }, []);
            const checkProxyStatus = async (p) => {
                try {
                    const res = await fetch(p + 'https://google.com', { method: 'HEAD' });
                    setIsProxyActive(res.ok);
                } catch (e) { setIsProxyActive(false); }
            };
            const validateSingleKey = async (platform, key, currentProxy) => {
                setApiStatus(prev => ({ ...prev, [platform]: 'loading' }));
                const pBase = currentProxy.endsWith('/') ? currentProxy : currentProxy + '/';
                try {
                    let url = '';
                    let headers = { 'Content-Type': 'application/json' };
                    if (platform === 'openai') url = 'https://api.openai.com/v1/models';
                    else if (platform === 'deepseek') url = 'https://api.deepseek.com/models';
                    else url = `https://generativelanguage.googleapis.com/v1/models?key=${key}`;
                    if (platform !== 'gemini') headers['Authorization'] = `Bearer ${key}`;
                   
                    const res = await fetch(pBase + url, { method: 'GET', headers });
                    if (!res.ok) {
                        const errorText = await res.text();
                        throw new Error(`Validation failed: ${res.status} - ${errorText}`);
                    }
                    setApiStatus(prev => ({ ...prev, [platform]: 'success' }));
                } catch (e) { 
                    setApiStatus(prev => ({ ...prev, [platform]: 'error' })); 
                    console.error(`${platform} validation error:`, e.message);
                }
            };
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const lines = text.split(/\r?\n/).filter(l => l.trim());
                    const hIdx = lines.findIndex(l => l.includes('Impression') && l.includes('Expense'));
                    if (hIdx === -1) return alert("é”™è¯¯ï¼šCSVæ–‡ä»¶ç¼ºå°‘å¿…è¦çš„å¹¿å‘Šæ•°æ®åˆ—ã€‚");
                    const headers = lines[hIdx].split(',').map(h => h.trim());
                    let totals = { spend: 0, gmv: 0, clicks: 0, imps: 0, orders: 0 };
                    lines.slice(hIdx + 1).forEach(line => {
                        const v = line.split(',');
                        const parse = (name) => {
                            const i = headers.indexOf(name);
                            return i > -1 ? parseFloat(v[i]?.replace(/[^0-9.]/g, '')) || 0 : 0;
                        };
                        totals.spend += parse('Expense');
                        totals.gmv += parse('GMV');
                        totals.clicks += parse('Clicks');
                        totals.imps += parse('Impression');
                        totals.orders += parse('Conversions');
                    });
                    setData(totals);
                };
                reader.readAsText(file);
            };
            const callAIApi = async (platform, key, prompt) => {
                const pBase = proxyUrl.endsWith('/') ? proxyUrl : proxyUrl + '/';
                let url = '', body = {}, headers = { 'Content-Type': 'application/json' };
                if (platform === 'openai' || platform === 'deepseek') {
                    url = platform === 'openai' ? 'https://api.openai.com/v1/chat/completions' : 'https://api.deepseek.com/v1/chat/completions';
                    headers['Authorization'] = `Bearer ${key}`;
                    body = {
                        model: PLATFORM_CONFIG[platform].model,
                        messages: [{ role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªèµ„æ·±ç”µå•†å¹¿å‘Šä¸“å®¶ï¼Œè¯·åªè¿”å›JSONæ ¼å¼ã€‚' }, { role: 'user', content: prompt }],
                        response_format: { type: "json_object" }
                    };
                } else {
                    url = `https://generativelanguage.googleapis.com/v1/models/${PLATFORM_CONFIG[platform].model}:generateContent?key=${key}`;
                    body = { 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { 
                            response_mime_type: "application/json",
                            response_schema: {
                                type: "object",
                                properties: {
                                    suggestions: {
                                        type: "array",
                                        items: {
                                            type: "object",
                                            properties: {
                                                title: { type: "string" },
                                                content: { type: "string" }
                                            },
                                            required: ["title", "content"]
                                        }
                                    }
                                },
                                required: ["suggestions"]
                            }
                        }
                    };
                }
                const response = await fetch(pBase + url, { method: 'POST', headers, body: JSON.stringify(body) });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API call failed: ${response.status} - ${errorText}`);
                }
                const json = await response.json();
               
                let rawText = '';
                if (platform === 'gemini') rawText = json.candidates[0].content.parts[0].text;
                else rawText = json.choices[0].message.content;
                try {
                    const match = rawText.match(/\{[\s\S]*\}/);
                    return match ? JSON.parse(match[0]) : JSON.parse(rawText);
                } catch (parseError) {
                    throw new Error(`JSON parse error: ${parseError.message}`);
                }
            };
            const runFullAnalysis = async () => {
                const activePlatforms = Object.entries(apiKeys).filter(([p, k]) => k && apiStatus[p] === 'success');
                if (activePlatforms.length === 0) return alert("æ— å¯ç”¨APIï¼šè¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®å¹¶ç¡®ä¿ç¯å·å˜ç»¿ã€‚");
                setLoading(true);
                setResults({});
                const roas = (data.gmv / data.spend).toFixed(2);
                const ctr = (data.clicks / data.imps * 100).toFixed(2);
                const cvr = (data.orders / data.clicks * 100).toFixed(2);
               
                const prompt = `æ•°æ®æŠ¥å‘Šï¼šå¹¿å‘ŠèŠ±è´¹${data.spend.toFixed(2)}, GMV ${data.gmv.toFixed(2)}, ROAS ${roas}, CTR ${ctr}%, è½¬åŒ–ç‡${cvr}%ã€‚è¯·ç»™å‡º3æ¡å…·ä½“çš„ä¼˜åŒ–å»ºè®®ï¼ŒæŒ‰æ­¤JSONæ ¼å¼è¿”å›ï¼š{"suggestions":[{"title":"..","content":".."}]}`;
                const tasks = activePlatforms.map(async ([platform, key]) => {
                    try {
                        const res = await callAIApi(platform, key, prompt);
                        setResults(prev => ({ ...prev, [platform]: { status: 'success', data: res } }));
                    } catch (e) {
                        setResults(prev => ({ ...prev, [platform]: { status: 'error', msg: e.message } }));
                        console.error(`${platform} analysis error:`, e.message);
                    }
                });
                await Promise.all(tasks);
                setLoading(false);
            };
            return (
                <div className="max-w-6xl mx-auto px-4 py-12">
                    {/* Header */}
                    <div className="flex justify-between items-start mb-12">
                        <div>
                            <h1 className="text-4xl font-black text-slate-900 tracking-tight mb-2">SHOPEE <span className="text-orange-600">AD ANALYZER</span></h1>
                            <div className="flex gap-4">
                                {Object.keys(apiKeys).map(p => (
                                    <div key={p} className="flex items-center text-[11px] font-bold text-slate-400 uppercase tracking-widest">
                                        <span className={`status-dot dot-${apiStatus[p]}`} /> {PLATFORM_CONFIG[p].name}
                                    </div>
                                ))}
                            </div>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-4 bg-white shadow-sm border border-slate-200 rounded-2xl hover:bg-slate-50 transition-all text-2xl">âš™ï¸</button>
                    </div>
                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-6">
                            <div className="bg-white rounded-[2.5rem] p-10 w-full max-w-md shadow-2xl scale-in-center">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-bold text-slate-800">API é›†ä¸­é…ç½®</h2>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600 text-2xl">âœ•</button>
                                </div>
                               
                                <div className={`mb-8 p-5 rounded-2xl flex justify-between items-center border ${isProxyActive ? 'bg-emerald-50 border-emerald-100' : 'bg-orange-50 border-orange-100'}`}>
                                    <span className="text-xs font-bold text-slate-600">CORS ä»£ç†: {isProxyActive ? 'âœ… å·²å°±ç»ª' : 'âš ï¸ éœ€æ¿€æ´»'}</span>
                                    {!isProxyActive && <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank" className="bg-orange-600 text-white text-[10px] px-3 py-2 rounded-xl font-black shadow-md hover:bg-orange-700">ç‚¹å‡»æ¿€æ´»</a>}
                                </div>
                                <div className="space-y-5">
                                    {Object.keys(apiKeys).map(p => (
                                        <div key={p}>
                                            <div className="flex justify-between mb-1.5 px-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{p} Secret Key</label>
                                                <span className={`text-[10px] font-bold ${apiStatus[p] === 'success' ? 'text-emerald-500' : 'text-slate-300'}`}>{apiStatus[p].toUpperCase()}</span>
                                            </div>
                                            <input type="password" value={apiKeys[p]} onChange={e => setApiKeys({...apiKeys, [p]: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 focus:border-orange-500 focus:bg-white rounded-2xl px-5 py-3.5 text-sm outline-none transition-all" placeholder={`sk-xxxx...`} />
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => {
                                    localStorage.setItem('shopee_pro_config', JSON.stringify({ keys: apiKeys, proxy: proxyUrl }));
                                    Object.entries(apiKeys).forEach(([p, k]) => { if(k) validateSingleKey(p, k, proxyUrl); });
                                    setShowSettings(false);
                                }} className="w-full mt-10 bg-slate-900 text-white font-bold py-5 rounded-[1.5rem] shadow-xl hover:bg-slate-800 transition-all active:scale-95">ä¿å­˜é…ç½®å¹¶åˆ·æ–°çŠ¶æ€</button>
                            </div>
                        </div>
                    )}
                    {/* Main Content */}
                    {!data ? (
                        <div className="border-4 border-dashed border-slate-200 rounded-[3rem] p-24 text-center glass-card group hover:border-orange-300 transition-all cursor-pointer relative overflow-hidden">
                            <input type="file" accept=".csv" onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                            <div className="text-8xl mb-6 group-hover:scale-110 transition-transform duration-500">ğŸ“Š</div>
                            <p className="text-2xl font-bold text-slate-800 mb-2">æ‹–æ”¾æˆ–ç‚¹å‡»ä¸Šä¼  CSV æŠ¥è¡¨</p>
                            <p className="text-slate-400 font-medium">æ”¯æŒ Shopee å®˜æ–¹å¯¼å‡ºçš„å¤šç«™ç‚¹å¹¿å‘Šæ•°æ®</p>
                        </div>
                    ) : (
                        <div className="space-y-10">
                            {/* Stats Grid */}
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-6">
                                {[
                                    { label: 'å¹¿å‘ŠèŠ±è´¹', value: data.spend.toFixed(2), color: 'text-orange-600', sub: 'THB / MYR' },
                                    { label: 'ROAS', value: (data.gmv / data.spend).toFixed(2), color: 'text-emerald-600', sub: 'æŠ•èµ„å›æŠ¥ç‡' },
                                    { label: 'ç‚¹å‡»ç‡ CTR', value: (data.clicks / data.imps * 100).toFixed(2) + '%', color: 'text-blue-600', sub: 'æµé‡æ•ˆç‡' },
                                    { label: 'æ€»æˆäº¤é¢', value: data.gmv.toFixed(2), color: 'text-purple-600', sub: 'GMV' }
                                ].map((s, i) => (
                                    <div key={i} className="glass-card p-8 rounded-[2.5rem] shadow-sm hover:shadow-md transition-shadow">
                                        <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1">{s.label}</p>
                                        <p className={`text-4xl font-black ${s.color} mb-1`}>{s.value}</p>
                                        <p className="text-[10px] text-slate-300 font-bold uppercase tracking-tighter">{s.sub}</p>
                                    </div>
                                ))}
                            </div>
                            {/* Action Button */}
                            <div className="flex justify-center pt-4">
                                <button onClick={runFullAnalysis} disabled={loading} className="bg-slate-900 text-white px-16 py-6 rounded-[2rem] font-black text-lg shadow-2xl hover:scale-105 active:scale-95 disabled:bg-slate-200 transition-all flex items-center gap-3">
                                    {loading ? <span className="flex gap-1"><span className="dot-loading status-dot" /><span className="dot-loading status-dot" /><span className="dot-loading status-dot" /></span> : 'ğŸš€ å¯åŠ¨å¤š AI è”è¯Šåˆ†æ'}
                                </button>
                            </div>
                            {/* AI Results */}
                            <div className="grid lg:grid-cols-3 gap-8 pb-20">
                                {Object.keys(PLATFORM_CONFIG).map(p => results[p] && (
                                    <div key={p} className={`ai-card glass-card rounded-[2.5rem] overflow-hidden border-t-[12px] ${PLATFORM_CONFIG[p].border}`}>
                                        <div className={`${PLATFORM_CONFIG[p].color} py-4 px-8 text-white font-black text-xs uppercase tracking-[0.2em] flex justify-between`}>
                                            {PLATFORM_CONFIG[p].name} EXPERT
                                            <span className="opacity-60">#2026-v4</span>
                                        </div>
                                        <div className="p-8">
                                            {results[p].status === 'success' ? (
                                                <div className="space-y-8">
                                                    {results[p].data.suggestions.map((s, idx) => (
                                                        <div key={idx} className="group">
                                                            <div className={`flex items-center gap-2 mb-2 font-black text-sm ${PLATFORM_CONFIG[p].text}`}>
                                                                <span className="w-6 h-6 rounded-lg bg-slate-100 flex items-center justify-center text-[10px]">{idx+1}</span>
                                                                {s.title}
                                                            </div>
                                                            <p className="text-slate-500 text-[13px] leading-relaxed font-medium pl-8 border-l border-slate-100 ml-3">
                                                                {s.content}
                                                            </p>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="py-12 text-center">
                                                    <div className="text-4xl mb-4">âš ï¸</div>
                                                    <p className="text-red-500 font-bold text-xs uppercase mb-2">è¯·æ±‚æ‹¦æˆªæˆ–æ•°æ®å†²çª</p>
                                                    <p className="text-slate-400 text-[10px] px-6 leading-normal">åŸå› å¯èƒ½ï¼š{results[p].msg}ã€‚è¯·æ£€æŸ¥ä»£ç†æ˜¯å¦æ¿€æ´»æˆ–Keyä½™é¢ã€‚</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
