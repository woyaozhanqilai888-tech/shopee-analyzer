<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopee GMV Max å¤šAIåˆ†æå·¥å…·</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        
        const ShopeeAdAnalyzer = () => {
          const [data, setData] = useState(null);
          const [analysis, setAnalysis] = useState(null);
          const [loading, setLoading] = useState(false);
          const [aiLoading, setAiLoading] = useState(false);
          const [apiKeys, setApiKeys] = useState({
            openai: '',
            claude: '',
            deepseek: '',
            gemini: '',
            xai: ''
          });
          const [showSettings, setShowSettings] = useState(false);
          const [multiAiResults, setMultiAiResults] = useState(null);
          const [finalSummary, setFinalSummary] = useState(null);

          const parseCSV = (text) => {
            const lines = text.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            
            const rows = lines.slice(1).map(line => {
              const values = line.split(',');
              const row = {};
              headers.forEach((header, index) => {
                row[header] = values[index]?.trim() || '';
              });
              return row;
            });
            
            return rows;
          };

          const analyzeData = (rawData) => {
            let totalSpend = 0;
            let totalImpressions = 0;
            let totalClicks = 0;
            let totalOrders = 0;
            let totalGMV = 0;
            let totalDirectGMV = 0;
            let totalItemsSold = 0;

            rawData.forEach(row => {
              totalSpend += parseFloat(row['èŠ±è´¹'] || row['å¹¿å‘ŠèŠ±è´¹'] || row['Expense'] || row['spend'] || 0);
              totalImpressions += parseInt(row['æ›å…‰'] || row['æµè§ˆæ•°'] || row['Impressions'] || row['impressions'] || 0);
              totalClicks += parseInt(row['ç‚¹å‡»'] || row['ç‚¹å‡»æ¬¡æ•°'] || row['Clicks'] || row['clicks'] || 0);
              totalOrders += parseInt(row['è®¢å•'] || row['è®¢å•æ•°'] || row['Orders'] || row['orders'] || 0);
              totalGMV += parseFloat(row['GMV'] || row['é”€å”®é‡‘é¢'] || row['gmv'] || 0);
              totalDirectGMV += parseFloat(row['ç›´æ¥GMV'] || row['ç›´æ¥é”€å”®é‡‘é¢'] || row['Direct GMV'] || row['direct_gmv'] || 0);
              totalItemsSold += parseInt(row['å•†å“å·²å‡ºå”®'] || row['Items Sold'] || row['items_sold'] || 0);
            });

            const ctr = totalImpressions > 0 ? (totalClicks / totalImpressions * 100).toFixed(2) : 0;
            const cpc = totalClicks > 0 ? (totalSpend / totalClicks).toFixed(2) : 0;
            const roas = totalSpend > 0 ? (totalGMV / totalSpend).toFixed(2) : 0;
            const directROAS = totalSpend > 0 ? (totalDirectGMV / totalSpend).toFixed(2) : 0;
            const conversionRate = totalClicks > 0 ? (totalOrders / totalClicks * 100).toFixed(2) : 0;
            const avgOrderValue = totalOrders > 0 ? (totalGMV / totalOrders).toFixed(2) : 0;

            const productsPerformance = rawData.map(row => ({
              name: row['å•†å“åç§°'] || row['äº§å“'] || row['Product'] || row['product'] || 'æœªçŸ¥å•†å“',
              spend: parseFloat(row['èŠ±è´¹'] || row['å¹¿å‘ŠèŠ±è´¹'] || row['Expense'] || row['spend'] || 0),
              gmv: parseFloat(row['GMV'] || row['é”€å”®é‡‘é¢'] || row['gmv'] || 0),
              orders: parseInt(row['è®¢å•'] || row['è®¢å•æ•°'] || row['Orders'] || row['orders'] || 0),
              roas: parseFloat(row['èŠ±è´¹'] || row['spend'] || 0) > 0 ? 
                (parseFloat(row['GMV'] || row['gmv'] || 0) / parseFloat(row['èŠ±è´¹'] || row['spend'] || 0)).toFixed(2) : 0
            })).filter(item => item.spend > 0);

            productsPerformance.sort((a, b) => parseFloat(b.roas) - parseFloat(a.roas));

            const suggestions = [];
            
            if (parseFloat(roas) < 1.5) {
              suggestions.push({
                type: 'danger',
                title: 'âš ï¸ ROASè¿‡ä½ - ç´§æ€¥ä¼˜åŒ–',
                content: `å½“å‰ROASä»…${roas}ï¼Œéœ€è¦è‡³å°‘1.5ä»¥ä¸Šæ‰èƒ½ç›ˆåˆ©`
              });
            } else if (parseFloat(roas) >= 3) {
              suggestions.push({
                type: 'success',
                title: 'ğŸ‰ ROASè¡¨ç°ä¼˜ç§€',
                content: `å½“å‰ROASè¾¾${roas}ï¼Œè¡¨ç°ä¼˜å¼‚ï¼`
              });
            }

            return {
              metrics: {
                totalSpend, totalImpressions, totalClicks, totalOrders,
                totalGMV, totalDirectGMV, totalItemsSold,
                ctr, cpc, roas, directROAS, conversionRate, avgOrderValue
              },
              topPerformers: productsPerformance.slice(0, 5),
              worstPerformers: productsPerformance.slice(-3).reverse(),
              suggestions
            };
          };

          const callSingleAI = async (platform, apiKey, dataForAI) => {
            const configs = {
              openai: {
                url: 'https://api.openai.com/v1/chat/completions',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: { model: 'gpt-4o', messages: [{ role: 'user', content: `åˆ†æShopee GMV Maxæ•°æ®å¹¶æä¾›3-5ä¸ªä¼˜åŒ–å»ºè®®ã€‚æ•°æ®ï¼š${JSON.stringify(dataForAI)}ã€‚ä»¥JSONæ ¼å¼å›å¤ï¼š{"suggestions": [{"title": "æ ‡é¢˜", "content": "è¯´æ˜", "priority": "high/medium/low"}]}` }] },
                extractResponse: (data) => data.choices[0].message.content
              },
              claude: {
                url: 'https://api.anthropic.com/v1/messages',
                headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01' },
                body: { model: 'claude-sonnet-4-20250514', max_tokens: 1500, messages: [{ role: 'user', content: `åˆ†æShopee GMV Maxæ•°æ®å¹¶æä¾›3-5ä¸ªä¼˜åŒ–å»ºè®®ã€‚æ•°æ®ï¼š${JSON.stringify(dataForAI)}ã€‚ä»¥JSONæ ¼å¼å›å¤ï¼š{"suggestions": [{"title": "æ ‡é¢˜", "content": "è¯´æ˜", "priority": "high/medium/low"}]}` }] },
                extractResponse: (data) => data.content[0].text
              },
              deepseek: {
                url: 'https://api.deepseek.com/v1/chat/completions',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: { model: 'deepseek-chat', messages: [{ role: 'user', content: `åˆ†æShopee GMV Maxæ•°æ®å¹¶æä¾›3-5ä¸ªä¼˜åŒ–å»ºè®®ã€‚æ•°æ®ï¼š${JSON.stringify(dataForAI)}ã€‚ä»¥JSONæ ¼å¼å›å¤ï¼š{"suggestions": [{"title": "æ ‡é¢˜", "content": "è¯´æ˜", "priority": "high/medium/low"}]}` }] },
                extractResponse: (data) => data.choices[0].message.content
              },
              gemini: {
                url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                headers: { 'Content-Type': 'application/json' },
                body: { contents: [{ parts: [{ text: `åˆ†æShopee GMV Maxæ•°æ®å¹¶æä¾›3-5ä¸ªä¼˜åŒ–å»ºè®®ã€‚æ•°æ®ï¼š${JSON.stringify(dataForAI)}ã€‚ä»¥JSONæ ¼å¼å›å¤ï¼š{"suggestions": [{"title": "æ ‡é¢˜", "content": "è¯´æ˜", "priority": "high/medium/low"}]}` }] }] },
                extractResponse: (data) => data.candidates[0].content.parts[0].text
              },
              xai: {
                url: 'https://api.x.ai/v1/chat/completions',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: { model: 'grok-beta', messages: [{ role: 'user', content: `åˆ†æShopee GMV Maxæ•°æ®å¹¶æä¾›3-5ä¸ªä¼˜åŒ–å»ºè®®ã€‚æ•°æ®ï¼š${JSON.stringify(dataForAI)}ã€‚ä»¥JSONæ ¼å¼å›å¤ï¼š{"suggestions": [{"title": "æ ‡é¢˜", "content": "è¯´æ˜", "priority": "high/medium/low"}]}` }] },
                extractResponse: (data) => data.choices[0].message.content
              }
            };

            const config = configs[platform];
            const response = await fetch(config.url, {
              method: 'POST',
              headers: config.headers,
              body: JSON.stringify(config.body)
            });

            if (!response.ok) throw new Error(`${platform} è°ƒç”¨å¤±è´¥`);
            const result = await response.json();
            const textResponse = config.extractResponse(result);
            
            let jsonMatch = textResponse.match(/\{[\s\S]*\}/);
            return jsonMatch ? JSON.parse(jsonMatch[0]) : { suggestions: [{ title: `${platform}å»ºè®®`, content: textResponse, priority: 'medium' }] };
          };

          const getMultiAISuggestions = async (analysisData) => {
            const activeAPIs = Object.entries(apiKeys).filter(([_, key]) => key.trim() !== '');
            if (activeAPIs.length === 0) {
              alert('è¯·è‡³å°‘é…ç½®ä¸€ä¸ªAIå¹³å°çš„API Key');
              setShowSettings(true);
              return;
            }

            setAiLoading(true);
            setMultiAiResults(null);
            setFinalSummary(null);

            const dataForAI = {
              æ ¸å¿ƒæŒ‡æ ‡: {
                æ€»GMV: `Â¥${analysisData.metrics.totalGMV.toFixed(2)}`,
                ROAS: analysisData.metrics.roas,
                ç‚¹å‡»ç‡: analysisData.metrics.ctr + '%',
                è½¬åŒ–ç‡: analysisData.metrics.conversionRate + '%'
              }
            };

            const results = {};
            
            await Promise.all(
              activeAPIs.map(async ([platform, key]) => {
                try {
                  results[platform] = { status: 'loading', data: null, error: null };
                  setMultiAiResults({...results});
                  
                  const response = await callSingleAI(platform, key, dataForAI);
                  results[platform] = { status: 'success', data: response, error: null };
                } catch (error) {
                  results[platform] = { status: 'error', data: null, error: error.message };
                }
                setMultiAiResults({...results});
              })
            );

            if (apiKeys.claude && Object.values(results).filter(r => r.status === 'success').length > 1) {
              try {
                const allSuggestions = Object.entries(results)
                  .filter(([_, r]) => r.status === 'success')
                  .map(([platform, r]) => ({ å¹³å°: platform, å»ºè®®: r.data.suggestions }));

                const summaryResponse = await fetch('https://api.anthropic.com/v1/messages', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', 'x-api-key': apiKeys.claude, 'anthropic-version': '2023-06-01' },
                  body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1500,
                    messages: [{ role: 'user', content: `ç»¼åˆä»¥ä¸‹AIå»ºè®®ï¼Œæç‚¼3-5ä¸ªæœ€é‡è¦å»ºè®®ï¼š${JSON.stringify(allSuggestions)}ã€‚ä»¥JSONæ ¼å¼å›å¤ï¼š{"summary": [{"title": "æ ‡é¢˜", "content": "è¯´æ˜", "priority": "high/medium/low", "sources": "æ¥æº"}]}` }]
                  })
                });

                if (summaryResponse.ok) {
                  const summaryResult = await summaryResponse.json();
                  const summaryText = summaryResult.content[0].text;
                  let jsonMatch = summaryText.match(/\{[\s\S]*\}/);
                  if (jsonMatch) setFinalSummary(JSON.parse(jsonMatch[0]));
                }
              } catch (error) {
                console.error('æ±‡æ€»å¤±è´¥:', error);
              }
            }

            setAiLoading(false);
          };

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setLoading(true);
            setMultiAiResults(null);
            setFinalSummary(null);
            const reader = new FileReader();
            
            reader.onload = (e) => {
              try {
                const text = e.target.result;
                const parsedData = parseCSV(text);
                setData(parsedData);
                const analysisResult = analyzeData(parsedData);
                setAnalysis(analysisResult);
              } catch (error) {
                alert('æ–‡ä»¶è§£æå¤±è´¥');
              } finally {
                setLoading(false);
              }
            };
            
            reader.readAsText(file);
          };

          const downloadSampleCSV = () => {
            const sampleData = `å•†å“åç§°,æ—¥æœŸ,å¹¿å‘ŠèŠ±è´¹,æ›å…‰,ç‚¹å‡»,è®¢å•æ•°,GMV,ç›´æ¥GMV,å•†å“å·²å‡ºå”®
æ— çº¿è“ç‰™è€³æœº,2026-01-10,280.50,15000,450,28,4200,3800,35
è¿åŠ¨æ°´æ¯,2026-01-10,150.80,8000,200,15,1800,1650,18`;
            
            const blob = new Blob([sampleData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'shopee_sample.csv';
            link.click();
          };

          const platformNames = {
            openai: 'ChatGPT',
            claude: 'Claude',
            deepseek: 'DeepSeek',
            gemini: 'Gemini',
            xai: 'Grok'
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-orange-50 to-red-50 p-4 md:p-8">
              <div className="max-w-7xl mx-auto">
                <div className="text-center mb-8">
                  <h1 className="text-4xl font-bold text-gray-800 mb-2">Shopee GMV Max å¤šAIåˆ†æ</h1>
                  <p className="text-gray-600">å¤šå¹³å°AIååŒåˆ†æ Â· æ™ºèƒ½æ±‡æ€»ä¼˜åŒ–å»ºè®®</p>
                  <button
                    onClick={() => setShowSettings(!showSettings)}
                    className="mt-4 bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300"
                  >
                    âš™ï¸ APIè®¾ç½®
                  </button>
                </div>

                {showSettings && (
                  <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                    <h2 className="text-xl font-bold mb-4">APIé…ç½®</h2>
                    {[
                      { key: 'openai', name: 'OpenAI (ChatGPT)', link: 'https://platform.openai.com/api-keys' },
                      { key: 'claude', name: 'Claude', link: 'https://console.anthropic.com/settings/keys' },
                      { key: 'deepseek', name: 'DeepSeek', link: 'https://platform.deepseek.com/api_keys' },
                      { key: 'gemini', name: 'Gemini', link: 'https://aistudio.google.com/app/apikey' },
                      { key: 'xai', name: 'Grok', link: 'https://x.ai/api' }
                    ].map(platform => (
                      <div key={platform.key} className="mb-4">
                        <label className="block font-medium mb-2">{platform.name}</label>
                        <input
                          type="password"
                          value={apiKeys[platform.key]}
                          onChange={(e) => setApiKeys({...apiKeys, [platform.key]: e.target.value})}
                          className="w-full px-4 py-2 border rounded-lg"
                        />
                        <a href={platform.link} target="_blank" className="text-xs text-orange-600">è·å–API Key â†’</a>
                      </div>
                    ))}
                    <button onClick={() => setShowSettings(false)} className="bg-orange-500 text-white px-6 py-2 rounded-lg w-full">ä¿å­˜</button>
                  </div>
                )}

                {!data && (
                  <div className="bg-white rounded-2xl p-8 text-center">
                    <label className="cursor-pointer">
                      <div className="border-4 border-dashed border-orange-300 rounded-xl p-12">
                        <p className="text-xl font-semibold mb-4">ä¸Šä¼ GMV Maxæ•°æ®</p>
                        <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                        <div className="bg-orange-500 text-white px-6 py-2 rounded-lg inline-block">é€‰æ‹©æ–‡ä»¶</div>
                      </div>
                    </label>
                    <button onClick={downloadSampleCSV} className="mt-4 text-orange-600 underline">ä¸‹è½½ç¤ºä¾‹CSV</button>
                  </div>
                )}

                {analysis && (
                  <div className="space-y-6">
                    <div className="grid md:grid-cols-4 gap-4">
                      <div className="bg-white rounded-xl p-6">
                        <p className="text-gray-600">æ€»GMV</p>
                        <p className="text-3xl font-bold">Â¥{analysis.metrics.totalGMV.toFixed(2)}</p>
                      </div>
                      <div className="bg-white rounded-xl p-6">
                        <p className="text-gray-600">ROAS</p>
                        <p className="text-3xl font-bold">{analysis.metrics.roas}</p>
                      </div>
                      <div className="bg-white rounded-xl p-6">
                        <p className="text-gray-600">ç‚¹å‡»ç‡</p>
                        <p className="text-3xl font-bold">{analysis.metrics.ctr}%</p>
                      </div>
                      <div className="bg-white rounded-xl p-6">
                        <p className="text-gray-600">è½¬åŒ–ç‡</p>
                        <p className="text-3xl font-bold">{analysis.metrics.conversionRate}%</p>
                      </div>
                    </div>

                    <div className="text-center">
                      <button
                        onClick={() => getMultiAISuggestions(analysis)}
                        disabled={aiLoading}
                        className="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-8 py-4 rounded-xl font-semibold disabled:opacity-50"
                      >
                        {aiLoading ? 'åˆ†æä¸­...' : 'ğŸš€ å¯åŠ¨å¤šAIåˆ†æ'}
                      </button>
                    </div>

                    {multiAiResults && (
                      <div className="grid md:grid-cols-3 gap-4">
                        {Object.entries(multiAiResults).map(([platform, result]) => (
                          <div key={platform} className="bg-white rounded-xl p-5">
                            <h3 className="font-bold mb-2">{platformNames[platform]}</h3>
                            {result.status === 'loading' && <p className="text-sm text-gray-500">åˆ†æä¸­...</p>}
                            {result.status === 'error' && <p className="text-sm text-red-600">âŒ {result.error}</p>}
                            {result.status === 'success' && result.data && (
                              <div className="space-y-2">
                                {result.data.suggestions.map((s, i) => (
                                  <div key={i} className="bg-gray-50 p-3 rounded text-sm">
                                    <p className="font-semibold">{s.title}</p>
                                    <p className="text-gray-600 text-xs">{s.content}</p>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    )}

                    {finalSummary && (
                      <div className="bg-purple-50 rounded-2xl p-6">
                        <h2 className="text-2xl font-bold mb-4">ğŸ¯ Claudeç»¼åˆå»ºè®®</h2>
                        {finalSummary.summary.map((item, i) => (
                          <div key={i} className="bg-white p-5 rounded-xl mb-3">
                            <h3 className="font-bold">{item.title}</h3>
                            <p className="text-gray-700 mt-2">{item.content}</p>
                            {item.sources && <p className="text-xs text-gray-500 mt-2">æ¥æº: {item.sources}</p>}
                          </div>
                        ))}
                      </div>
                    )}

                    <div className="text-center">
                      <button
                        onClick={() => { setData(null); setAnalysis(null); setMultiAiResults(null); setFinalSummary(null); }}
                        className="bg-orange-500 text-white px-8 py-3 rounded-lg"
                      >
                        åˆ†ææ–°æ•°æ®
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<ShopeeAdAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
